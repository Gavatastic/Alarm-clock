//  BSS138 mosfets
// Breshanen line drawing


#include <asf.h>
#include <I2C.h>
#include <SSD1306.h>
#include <framebuffer.h>

/*
Keyboard mapping

Inputs
PB07 - Column 1
PB06 - Column 2
PB05 - Column 3
PB04 - Column 4

PB03 - Row 1
PB02 - Row 2
PB01 - Row 3
PB00 - Row 4

*/


const uint8_t Atomic []  = {
	0x00, 0x00, 0x00, 0x07, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x3C, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x1C, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x60, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0x07, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x01, 0xC0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x03, 0x80, 0x00, 0x00,
	0x00, 0x00, 0x03, 0x80, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x01, 0xC0, 0x00, 0x00,
	0x00, 0x00, 0x03, 0x00, 0x00, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0xC0, 0x00, 0x00,
	0x00, 0x3F, 0xC6, 0x00, 0x00, 0x67, 0xFC, 0x00, 0x01, 0xFF, 0xFE, 0x00, 0x00, 0xFF, 0xFF, 0x80,
	0x07, 0xC0, 0x3F, 0xC0, 0x03, 0xFC, 0x03, 0xC0, 0x07, 0x00, 0x0F, 0xF8, 0x1F, 0xF0, 0x00, 0xE0,
	0x0C, 0x00, 0x0C, 0x3E, 0xFC, 0x30, 0x00, 0x70, 0x0C, 0x00, 0x0C, 0x0F, 0xE0, 0x30, 0x00, 0x30,
	0x18, 0x00, 0x1C, 0x0F, 0xF0, 0x30, 0x00, 0x38, 0x18, 0x00, 0x18, 0x3E, 0x78, 0x30, 0x00, 0x38,
	0x18, 0x00, 0x18, 0x78, 0x1E, 0x18, 0x00, 0x38, 0x1C, 0x00, 0x19, 0xE0, 0x07, 0x98, 0x00, 0x30,
	0x0C, 0x00, 0x1F, 0x80, 0x01, 0xF8, 0x00, 0x30, 0x0C, 0x00, 0x1F, 0x00, 0x00, 0xF8, 0x00, 0x70,
	0x06, 0x00, 0x3C, 0x00, 0x00, 0x38, 0x00, 0x60, 0x06, 0x00, 0x78, 0x00, 0x00, 0x1E, 0x00, 0xE0,
	0x03, 0x00, 0xF0, 0x00, 0x00, 0x1F, 0x00, 0xC0, 0x03, 0x81, 0xF0, 0x00, 0x00, 0x1F, 0x81, 0xC0,
	0x01, 0xC7, 0xB0, 0x03, 0x80, 0x19, 0xC3, 0x80, 0x00, 0xCE, 0x30, 0x07, 0xE0, 0x1C, 0xF7, 0x00,
	0x00, 0xFC, 0x30, 0x0F, 0xE0, 0x1C, 0x3E, 0x00, 0x00, 0x78, 0x30, 0x0F, 0xF0, 0x1C, 0x1C, 0x00,
	0x00, 0x78, 0x30, 0x0F, 0xF0, 0x1C, 0x1C, 0x00, 0x00, 0xFC, 0x30, 0x0F, 0xE0, 0x1C, 0x3E, 0x00,
	0x00, 0xCE, 0x30, 0x07, 0xE0, 0x1C, 0xF7, 0x00, 0x01, 0xC7, 0xB0, 0x03, 0xC0, 0x19, 0xC3, 0x80,
	0x03, 0x81, 0xF0, 0x00, 0x00, 0x1F, 0x81, 0xC0, 0x03, 0x00, 0xF0, 0x00, 0x00, 0x1F, 0x00, 0xC0,
	0x06, 0x00, 0x78, 0x00, 0x00, 0x1E, 0x00, 0xE0, 0x06, 0x00, 0x3C, 0x00, 0x00, 0x38, 0x00, 0x60,
	0x0C, 0x00, 0x1F, 0x00, 0x00, 0xF8, 0x00, 0x30, 0x0C, 0x00, 0x1F, 0x80, 0x01, 0xF8, 0x00, 0x30,
	0x1C, 0x00, 0x19, 0xE0, 0x07, 0x98, 0x00, 0x30, 0x18, 0x00, 0x18, 0xF8, 0x1E, 0x18, 0x00, 0x38,
	0x18, 0x00, 0x18, 0x3E, 0x7C, 0x30, 0x00, 0x18, 0x18, 0x00, 0x1C, 0x0F, 0xF0, 0x30, 0x00, 0x38,
	0x1C, 0x00, 0x0C, 0x07, 0xE0, 0x30, 0x00, 0x30, 0x0C, 0x00, 0x0C, 0x3F, 0xFC, 0x30, 0x00, 0x30,
	0x0E, 0x00, 0x0F, 0xF8, 0x1F, 0xF0, 0x00, 0x60, 0x07, 0xC0, 0x3F, 0xC0, 0x07, 0xF8, 0x03, 0xE0,
	0x01, 0xFF, 0xFE, 0x00, 0x00, 0xFF, 0xFF, 0x80, 0x00, 0x7F, 0xE6, 0x00, 0x00, 0x67, 0xFE, 0x00,
	0x00, 0x00, 0x06, 0x00, 0x00, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0xC0, 0x00, 0x00,
	0x00, 0x00, 0x03, 0x00, 0x01, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x01, 0x80, 0x00, 0x00,
	0x00, 0x00, 0x01, 0x80, 0x03, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0xC0, 0x03, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0xE0, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x0E, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x30, 0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x38, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xC0, 0x00, 0x00, 0x00
};

uint8_t fb[SSD1306_BUFFERSIZE];


void configure_port_pins(void)
{
	struct port_config config_port_pin;
	
	// Inputs
	port_get_config_defaults(&config_port_pin);
	config_port_pin.direction  = PORT_PIN_DIR_INPUT;
	config_port_pin.input_pull = PORT_PIN_PULL_DOWN;
	port_pin_set_config(PIN_PB03, &config_port_pin);
	
	// Outputs
	config_port_pin.direction = PORT_PIN_DIR_OUTPUT;
	port_pin_set_config(PIN_PB02, &config_port_pin);
	//config_port_pin.direction = PORT_PIN_DIR_OUTPUT;
	//port_pin_set_config(PIN_PB01, &config_port_pin);
	//config_port_pin.direction = PORT_PIN_DIR_OUTPUT;
	//port_pin_set_config(PIN_PB02, &config_port_pin);
	//config_port_pin.direction = PORT_PIN_DIR_OUTPUT;
	//port_pin_set_config(PIN_PB03, &config_port_pin);	

}


int main (void)
{
	uint16_t buttons;
	uint32_t keyvalue;
	
	system_init();
	delay_init();
	ioport_init();
	configure_port_pins();

	//ioport_set_port_dir(KeyRows, KeyRowMask, IOPORT_DIR_OUTPUT);	
	//ioport_set_port_dir(KeyCols, KeyColMask, IOPORT_DIR_INPUT);	
			 
    configure_i2c_master();
	SSD1306_init();
  
	buffer_clear(fb);
	buffer_drawBitmap(fb, Atomic,64,64,32,0);
	SSD1306_send_buffer(fb);
	
	delay_s(1);
  
	buffer_clear(fb);
	buffer_drawButtonOutlines(fb);
	SSD1306_send_buffer(fb);
    
	port_pin_set_output_level(PIN_PB00, true);
	port_pin_set_output_level(PIN_PB01, true);
	port_pin_set_output_level(PIN_PB02, true);
	port_pin_set_output_level(PIN_PB03, true);
	
	 
	 
	while(1==1)
	{
		buttons=0;
		//for (uint8_t row=0; row<4; row++)
		//{
			//ioport_set_port_level(KeyRows, KeyRowMask, 1<<row);
			//keyvalue=ioport_get_port_level(KeyRows, KeyRowMask);
//
			//for (uint8_t col=0; col<4; col++)
			//{
				//if (keyvalue & (1<<col)) buttons = buttons & (1<<((row*4)+col));	
			//}	
			//
		//}
		//if (keyvalue==0) 
		//{
			//buffer_WriteText(fb,&robo12_FontInfo,"0",0,0,2);
		//} else {
			//buffer_WriteText(fb,&robo12_FontInfo,"X",0,0,2);
		//}
		//buffer_drawButtonStates(fb,buttons);
		
		if (port_pin_get_input_level(PIN_PB04)) 
		{
			buffer_drawButtonStates(fb,1);
		} else {
			buffer_drawButtonStates(fb,0);
			
		}
		
		SSD1306_send_buffer(fb);
	}
	

	
	
}

